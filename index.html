<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Trade & Transport</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
    <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
    <style type="text/css">
      body {
        display: grid;
        grid-template-columns: 140px 800px 240px;
        grid-template-rows: 445px 355px;
        grid-gap: 0.1em;
        margin: auto;
      }

      #chart-container {
        grid-column: 2 / span 1;
        grid-row: 1 / span 2;
        padding: 5px;
      }

      #key-container {
        grid-column: 1 / span 1;
        grid-row: 1 / span 1;
        overflow: hidden;
        padding: 30px;
      }

      #control-container {
        grid-column: 1 / span 1;
        grid-row: 2 / span 1;
        overflow: hidden;
        padding: 10px 20px;
      }

      #hover-info-container {
        grid-column: 3 / span 1;
        grid-row: 1 / span 2;
        overflow: hidden;
        padding: 5px;
      }

      #save-button-container {
        margin-top: 40px;
        text-align: center;
      }

      @font-face {
        font-family: "Graphik Regular";
        font-style: normal;
        font-weight: normal;
        src: local("Graphik Regular"), url("GraphikRegular.woff") format("woff");
      }

      @font-face {
        font-family: "Graphik Bold";
        font-style: normal;
        font-weight: bold;
        src: local("Graphik Bold"), url("GraphikBold.woff") format("woff");
      }

      .segment {
        stroke: white;
        stroke-width: 2px;
      }

      .existing-segments {
        fill: #dfdfdf;
      }

      .emerging-segments {
        fill: #e9e9e9;
      }

      .distant-segments {
        fill: #f4f4f4;
      }

      .segment-band {
        stroke: white;
        stroke-width: 2px;
      }

      .label-text {
        fill: white;
        text-anchor: middle;
        font-weight: bold;
        font-size: 7px;
        font-family: "Graphik Bold";
      }

      .labels-theme-text {
        fill: white;
        text-anchor: middle;
        font-weight: bold;
        font-size: 10px;
        font-family: "Graphik Bold";
      }

      .funding-hover-info {
        fill: black;
        text-anchor: middle;
        font-weight: bold;
        font-size: 10px;
        font-family: "Graphik Regular";
        pointer-events: none;
      }

      .funding-hover-info.amount {
        font-size: 12px;
      }

      .funding-hover-info.title {
        font-size: 12px;
        font-family: "Graphik Bold";
      }

      .year-labels {
        fill: #8b8b8b;
        text-anchor: middle;
        font-size: 8px;
        font-family: "Graphik Bold";
      }

      .maturity-labels {
        fill: #8b8b8b;
        text-anchor: middle;
        font-size: 8px;
        font-family: "Graphik Bold";
      }

      .nodes {
        stroke: black;
        stroke-width: 1px;
      }

      .wrap-header {
        font-family: "Graphik Bold";
        font-weight: bold;
      }

      #chart-container {
        text-align: center;
      }

      .node-mouse-over-box {
        pointer-events: none;
      }

      .node-mouse-over-text {
        font-size: 10px;
        text-anchor: start;
        font-weight: bold;
        fill: #404e4d;
        font-family: "Graphik Regular";
        pointer-events: none;
        width: 100px;
      }

      .chart-title {
        font-family: "Graphik Bold";
        font-weight: bold;
        text-anchor: middle;
        font-size: 28px;
      }

      .key-label {
        font-family: "Graphik Regular";
        font-size: 10px;
        cursor: pointer;
      }

      .key-item {
        stroke: black;
        stroke-width: 1px;
        fill: white;
        cursor: pointer;
      }

      .key-item-other {
        stroke: black;
        stroke-width: 1px;
        cursor: pointer;
      }

      .key-title {
        font-weight: bold;
        font-family: "Graphik Bold";
        font-size: 12px;
      }

      .segment-band {
        cursor: pointer;
      }

      #switch-button {
        cursor: pointer;
        background-color: #8e8e8e;
        color: #faf0e6;
        padding: 10px;
        font-family: "Graphik Regular";
        font-size: 10px;
        border: none;
        cursor: pointer;
        text-anchor: middle;
        min-width: 100px;
      }

      #switch-button:hover {
        background-color: #e74668;
      }

      #switch-button-label {
        font-weight: bold;
        font-family: "Graphik Regular";
        font-size: 10px;
        text-anchor: middle;
        pointer-events: none;
      }

      /* Dropdown Button */
      .dropbtn {
        background-color: #b7b7b7;
        color: white;
        padding: 10px;
        font-family: "Graphik Regular";
        font-weight: bold;
        font-size: 10px;
        border: none;
        cursor: pointer;
        min-width: 120px;
        text-anchor: middle;
      }

      /* The container <div> - needed to position the dropdown content */
      .dropdown-industry {
        position: relative;
        display: inline-block;
        text-anchor: middle;
      }

      /* Dropdown Content (Hidden by Default) */
      .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f1f1f1;
        min-width: 120px;
        z-index: 1;
        max-height: 530px;
        overflow: auto;
        text-anchor: middle;
      }

      /* Links inside the dropdown */
      .dropdown-content a {
        color: #404e4d;
        font-size: 10px;
        font-family: "Graphik Regular";
        font-weight: bold;
        padding: 8px 0px;
        text-decoration: none;
        display: block;
        text-anchor: middle;
        text-align: center;
      }

      /* Change color of dropdown links on hover */
      .dropdown-content a:hover {
        background-color: #ddd;
      }

      /* Show the dropdown menu on hover */
      .dropdown-industry:hover .dropdown-content {
        display: block;
      }

      .dropdown-league:hover .dropdown-content {
        display: block;
      }

      /* Change the background color of the dropdown button when the dropdown content is shown */
      .dropdown-industry:hover .dropbtn {
        background-color: #e74668;
      }

      .switch-button {
        cursor: pointer;
        color: white;
        padding: 10px;
        font-family: "Graphik Regular";
        font-size: 10px;
        border: none;
        cursor: pointer;
        text-anchor: middle;
        width: 100px;
        font-weight: bold;
      }

      .switch-button-label {
        font-weight: bold;
        font-family: "Graphik Regular";
        font-size: 10px;
        text-anchor: middle;
        pointer-events: none;
      }

      #map-button,
      #save-button {
        background-color: #b7b7b7;
      }

      #map-button:hover,
      #save-button:hover {
        background-color: #e74668;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }

      /* Hide default HTML checkbox */
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      /* The slider */
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #8e8e8e;
        -webkit-transition: 0.4s;
        transition: 0.4s;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        -webkit-transition: 0.4s;
        transition: 0.4s;
      }

      input:checked + .slider {
        background-color: #ea3b66;
      }

      input:focus + .slider {
        box-shadow: 0 0 1px #ea3b66;
      }

      input:checked + .slider:before {
        -webkit-transform: translateX(26px);
        -ms-transform: translateX(26px);
        transform: translateX(26px);
      }

      .toggle-button-cover {
        display: table-cell;
        position: relative;
        width: 300px;
        height: 140px;
        box-sizing: border-box;
      }

      .button-cover {
        height: 100px;
        margin: 20px;
        background-color: #fff;
        box-shadow: 0 10px 20px -8px #c5d6d6;
        border-radius: 4px;
      }

      .button-cover:before {
        counter-increment: button-counter;
        content: counter(button-counter);
        position: absolute;
        right: 0;
        bottom: 0;
        color: #d7e3e3;
        font-size: 12px;
        line-height: 1;
        padding: 5px;
      }

      .button-cover,
      .knobs,
      .layer {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      .button {
        position: relative;
        top: 50%;
        width: 120px;
        height: 36px;
        margin: 0px auto 0 auto;
        overflow: hidden;
      }

      .button.r,
      .button.r .layer {
        border-radius: 100px;
      }

      .button.b2 {
        border-radius: 1px;
      }

      .checkbox {
        position: relative;
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        opacity: 0;
        cursor: pointer;
        z-index: 3;
      }

      .knobs {
        z-index: 2;
      }

      .layer {
        width: 100%;
        background-color: #ebf7fc;
        transition: 0.8s ease all;
        z-index: 1;
      }

      #button-16 .knobs:before {
        content: "Year";
        position: absolute;
        top: 4px;
        left: 4px;
        width: 60px;
        height: 10px;
        color: #fff;
        font-size: 10px;
        font-family: "Graphik Regular";
        font-weight: bold;
        text-align: center;
        line-height: 1;
        padding: 9px 4px;
        background-color: #5fbdfb;
        border-radius: 2px;
        transition: 0.8s ease all,
          left 0.8s cubic-bezier(0.18, 0.89, 0.35, 1.15);
      }

      #button-17 .knobs:before {
        content: "Startups";
        position: absolute;
        top: 4px;
        left: 4px;
        width: 60px;
        height: 10px;
        color: #fff;
        font-size: 10px;
        font-family: "Graphik Regular";
        font-weight: bold;
        text-align: center;
        line-height: 1;
        padding: 9px 4px;
        background-color: #5fbdfb;
        border-radius: 2px;
        transition: 0.8s ease all,
          left 0.8s cubic-bezier(0.18, 0.89, 0.35, 1.15);
      }

      #button-17 .checkbox:checked + .knobs:before {
        content: "Competitors";
        left: 46px;
        background-color: #ea3b66;
      }

      #button-17 .checkbox:active + .knobs:before,
      #button-16 .checkbox:active + .knobs:before {
        width: 46px;
      }

      #button-17
        .checkbox:checked:active
        + .knobs:before
        #button-16
        .checkbox:checked:active
        + .knobs:before {
        margin-left: -26px;
      }

      #button-16 .checkbox:checked + .knobs:before {
        content: "Maturity";
        left: 46px;
        background-color: #ea3b66;
      }

      #button-17 .checkbox:checked ~ .layer,
      #button-16 .checkbox:checked ~ .layer {
        background-color: #fcebeb;
      }

      i {
        border: solid white;
        border-width: 0 2px 2px 0;
        display: inline-block;
        padding: 2px;
      }

      .down {
        transform: rotate(45deg);
        -webkit-transform: rotate(45deg);
      }

            #map {
      }

      .bg {
        background-color: #cbcbcb;
        position: absolute;
        top: 0px;
        left: 0px;
        height: 100%;
        width: 100%;
        z-index: -1;
      }

      .country {
        stroke-width: 1.5px;
        stroke: #cbcbcb;
      }

      .sidebar {
        position: absolute;
        width: 380px;
        height: 100%;
        background-color: #fcfcfc;
        border-left: 2px solid #949494;
        right: 0px;
        top: 0px;
      }

      .country-circle {
        fill-opacity: 0.3;
        stroke-width: 3px;
      }

      #chart-button {
        background-color: #b7b7b7;
        position: absolute;
        left: 150px;
        top: 700px;
      }

      #chart-button:hover {
        background-color: #e74668;
      }

      .map-tooltip {
        background-color: #383838;
        border: 1px solid black;
        font-weight: bold;
        font-family: "Graphik Regular";
        font-size: 14px;
        border-radius: 10px;
        min-width: 100px;
        text-align: center;
        color: white;
        position: absolute;
        padding: 10px;
      }

      .sidebar-title {
        font-weight: bold;
        font-family: "Graphik Bold";
        text-align: center;
        font-size: 36px;
        padding-top: 60px;
        padding-bottom: 20px;
        text-transform: uppercase;
      }

      #startup-list {
        padding: 40px;
        max-height: 300px;
        overflow: scroll;
      }

      .startup-table {
        min-width: 300px;
        max-height: 300px;
        overflow: scroll;
        font-family: "Graphik Regular";
        background-color: white;
        border: 1px solid #949494;
        padding: 10px;
      }

      .startup-table tr {
        font-size: 12px;
        height: 25px;
      }

      .startup-table td {
        min-width: 60px;
      }

      .table-header {
        font-family: "Graphik Bold";  
      }
    </style>
  </head>

  <body>
    <div id="chart-container"></div>
    <div id="key-container"></div>
    <div id="control-container">
        <button class="switch-button" id="map-button">View Map</button>
      <div>

          <div class="dropdown-industry">
          </div>
        </div>
      </div>
    </div>
    <div id="hover-info-container"></div>
        <div class="map-container">
      <div class="map-tooltip"></div>
      <div class="bg"></div>
      <div id="map"></div>

      <div class="sidebar">
        <div class="sidebar-title"></div>
        <div id="startup-list"></div>
         <button class="switch-button" id="chart-button">View Chart</button>
      </div>
    </div>
    <div id="tmp-container"></div>
    <div id="save-button-container">
      <button class="switch-button" id="save-button">Save Image</button>
    </div>

    <script>
      var width = 800,
        height = 860,
        innerRadius = 50,
        outerRadius = 300,
        keySize = 10,
        keySpacing = 10,
        radial = "year",
        animationDuration = 2000,
        keyWidth = 140,
        keyHeight = 425,
        filter = 0,
        filterKey = "",
        industryFilter = "All Startups",
        logoPath = "FLSmidth.png",
        titleLogoWidth = 80,
        titleLogoHeight = 50,
        hoverOn = 0;
      hoverSegment = "",
      leftWidth = 1100,
        leftHeight = 700;

      /* d3.select("#switch-button-maturity").style("background-color", "#5FBDFB")
        .on("mouseover", function () {
          d3.select(this).style("background-color", "#EA3B66")
        })
        .on("mouseout", function () {
          if (radial === 'maturity') {
            d3.select(this).style("background-color", "#5FBDFB")
          } else {
            d3.select(this).style("background-color", "#8e8e8e")
          }
        })

      d3.select("#switch-button-year").style("background-color", "#8e8e8e")
        .on("mouseover", function () {
          d3.select(this).style("background-color", "#EA3B66")
        })
        .on("mouseout", function () {
          if (radial === 'year') {
            d3.select(this).style("background-color", "#5FBDFB")
          } else {
            d3.select(this).style("background-color", "#8e8e8e")
          }
        }) */

      var svg = d3
        .select("#chart-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      var chartSVG = svg
        .append("g")
        .attr(
          "transform",
          "translate(" + width / 2 + "," + (height / 2 + 20) + ")"
        );

      var keySVG = d3
        .select("#key-container")
        .append("svg")
        .attr("width", keyWidth)
        .attr("height", keyHeight)
        .append("g")
        .attr(
          "transform",
          "translate(" + keyWidth / 2 + "," + keyHeight / 2 + ")"
        );

      var hoverSVG = d3
        .select("#hover-info-container")
        .append("svg")
        .attr("width", 200)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(" + 200 / 2 + "," + height / 2 + ")");

      var chartTitle = chartSVG
        .append("text")
        .attr("class", "chart-title")
        .text("Trade & Transport")
        .attr("y", (-height * 4.55) / 10);

      var leftProjection = d3
        .geoMercator()
        .translate([leftWidth / 2, leftHeight / 2])
        .center([0.2, 30.7])
        .scale([180]);

      var leftSVG = d3
        .select("#map")
        .append("svg")
        .attr("width", leftWidth)
        .attr("height", leftHeight);

      leftSVG
        .append("rect")
        .attr("fill", "#CBCBCB")
        .attr("width", leftWidth)
        .attr("height", leftHeight);

                        d3.select(".map-container").style("display", "none")
                d3.select(".map-tooltip").style("display", "none")

      var leftG = leftSVG.append("g");

      var leftPath = d3.geoPath().projection(leftProjection);

      /* var chartLogo = chartSVG
        .append("image")
        .attr("xlink:href", logoPath)
        .attr("width", titleLogoWidth)
        .attr("height", titleLogoHeight)
        .attr("y", -titleLogoHeight / 2)
        .attr("x", -titleLogoWidth / 2); */

      //CHANGE HERE:
      var focusAreaOrder = [
        "container logistics optimisation",
        "automated port infrastructure",
        "disaster proofing and management",
        "port configuration and planning",
        "port bottleneck optimisation",
        "data audit & standardisation",
        "digital twin of port",
        "port cybersecurity",
        "in-land infrastructure development",
        "time sensitive transport",
        "paperwork simplification_reduction",
        "intelligent freight price discovery",
        "end-to-end supply chain transparency",
        "automated port surveillance",
        "retrofitting existing vessels with green tech"
      ];

      //CHANGE HERE:
      var themeOrder = [
        "Physical Process Enhancement",
        "Smart Ports",
        "Supply chain optimisation",
        "Eco friendly enforcement & enablement"
      ];

      d3.csv(
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vSafGm_gSEK_M6dTEcS3sd2N7CcehHPfg561BJtgzrHClIt5DH79yqHI1LpeOLbbwGob_Xi0kVUdxMB/pub?gid=610250001&single=true&output=csv"
      ).then(function(data) {
        d3.csv(
          "https://docs.google.com/spreadsheets/d/e/2PACX-1vSafGm_gSEK_M6dTEcS3sd2N7CcehHPfg561BJtgzrHClIt5DH79yqHI1LpeOLbbwGob_Xi0kVUdxMB/pub?gid=1496992423&single=true&output=csv"
        ).then(function(desc) {

            d3.json("world_countries.json").then(function(json) {


            json.features.push({"type": "features", "properties": {"name": "Singapore"}, "geometry": {"type": "Polygon", "coordinates": [[0, 0]]}})
            json.features.push({"type": "features", "properties": {"name": "Bahrain"}, "geometry": {"type": "Polygon", "coordinates": [[0, 0]]}})

            d3.select("#chart-button").on("click", function() {
              toggle_map("off");
            });

            function country_hover(d, i) {
              d3.selectAll(".country-circle")
                .attr("fill", "#ea3b66")
                .attr("stroke", "#ea3b66");
              d3.select(this)
                .attr("fill", "#F5D932")
                .attr("stroke", "#F5D932");
              var tooltip = "<div>" + d.properties.name + "<\/div>";
              tooltip += "<div>Startups: " + d.properties.startups + "<\/div>";
              d3.select(".map-tooltip")
                .html(tooltip)
                .style("top", function() {
                  return leftCentroids[i][1] + "px";
                })
                .style("left", function() {
                  return leftCentroids[i][0] + "px";
                })
                .style("display", "");

              d3.select(".sidebar-title").html(d.properties.name);

              startup_list = [];
              data.forEach(function(w) {
                if (w.Country === d.properties.name) {
                  var obj = {
                    Startup: w.Startup,
                    Funding: w["Total \nfunding (US$)"],
                    URL: w["URL"],
                    Year: w["Founded"]
                  };
                  startup_list.push(obj);
                }
              });
              var table = "";
              table += "<table class='startup-table'>";
                table +=
                  "<tr class='table-header'><td>Company:<\/td><td>Funding:<\/td><td>Founded Year:<\/td><\/tr>"
              startup_list.forEach(function(v) {
                  console.log(v)
                table +=
                  "<tr><td><a href='" + v.URL + "' target='_blank'>" +
                  v.Startup +
                  "</a><\/td><td>$" +
                    formatFunding(v.Funding) +
                  "<\/td><td>" +
                  v.Year +
                  "<\/td><\/tr>";
              });
              table += "<\/table>";
              d3.select("#startup-list").html(table);
            }
            console.log(json);

            var leftCentroids = json.features.map(function(feature) {
              return leftPath.centroid(feature);
            });

            console.log(leftCentroids)

            // manual adjustments to country centroids:
            leftCentroids[170] = [160.28813150973434, 200.53652705535595];
            leftCentroids[28] = [133.39281332553415, 132.40027710817226];
            leftCentroids[6] = [499.3566464049186, 484.20930510242];
            leftCentroids[121] = [381.8299314691847, 98.47135868701795];
            leftCentroids[177] = [890, 450]
            leftCentroids[178] = [708, 370]

            data_country = d3
              .nest()
              .key(function(d) {
                return d.Country;
              })
              .entries(data);

            console.log(data_country);

            json_country = d3
              .nest()
              .key(function(d) {
                return d.properties.name;
              })
              .entries(json.features);

              

            data.forEach(function(v) {
              //console.log(v["Country"]);
              json.features.forEach(function(w) {
                if (v["Country"] === w.properties.name) {
                  v.json_country = w.properties.name;
                }
              });
            });

            var countries = leftG
              .selectAll(".country")
              .data(json.features)
              .enter()
              .append("path")
              .attr("d", leftPath)
              .attr("class", "country")
              .attr("id", function(d) {
                return "country_" + d.properties.name.replace(/ /g, "-");
              })
              .attr("fill", "#EFEFEF");

            json.features.forEach(function(w) {
              w.properties.startups = 0;
              data.forEach(function(v) {
                if (v["Country"] === w.properties.name) {
                  v.json_country = w.properties.name;
                  w.properties.startups += 1;
                }
              });
            });

            var max_country = d3.max(json.features, function(w) {
                return w.properties.startups
            })

            console.log(max_country)

            var countryCircleScale = d3.scaleSqrt()
            .domain([1,max_country])
            .range([2.6, 30]);

            leftG
              .selectAll("circlce")
              .data(json.features)
              .enter()
              .append("circle")
              .classed("country-circle", true)
              .attr("r", function(d) {
                if (d.properties.startups > 0) {
                  return countryCircleScale(d.properties.startups);
                }
              })
              .attr("cx", function(d, i) {
                return leftCentroids[i][0];
              })
              .attr("cy", function(d, i) {
                return leftCentroids[i][1];
              })
              .attr("fill", "#ea3b66")
              .attr("stroke", "#ea3b66")
              .on("mouseover", country_hover);

            // END::END

          console.log(data);

          data = data.filter(function(d) {
            return d["Opportunity Space"] !== "";
          });

          data = data.filter(function(d) {
            return d["Founded"] !== "";
          });

          console.log(desc);

          // correct formatting of total funding values to numbers
          data.forEach(function(d) {
            d["Total \nfunding (US$)"] = d["Total \nfunding (US$)"].replace(
              /,/g,
              ""
            );
            if (d["Total \nfunding (US$)"] === "" || d["Total \nfunding (US$)"] === "Unfunded" || d["Total \nfunding (US$)"] === "Funded") {
              d["Total \nfunding (US$)"] = 0;
            }

            d["Total \nfunding (US$)"] = (d["Total \nfunding (US$)"])

            d["Opportunity Space"] = d["Opportunity Space"]
              .toLowerCase()
              .replace(/\//g, "_");

            desc.forEach(function(v) {
              if (
                d["Opportunity Space"] ===
                v["Opportunity Space"].toLowerCase().replace(/\//g, "_")
              ) {
                d["Themes"] = v["Themes"];
                d["Theme Definition"] = v["Theme Definition"];
              }
            });
          });

          /* var oppSpace_order = [
              "end of life care",
              "connected health",
              "non-invasive diagnostics",
              "chronic disease management",
              "growing wealth management",
              "will & succession planning",
              "smart agency"
            ];

            */

          function focusAreaSort(a, b) {
            for (i = 0; i < focusAreaOrder.length; i++) {
              if (a === focusAreaOrder[i]) {
                var valA = i;
              }
              if (b === focusAreaOrder[i]) {
                var valB = i;
              }
            }
            return valA < valB ? -1 : valA > valB ? 1 : valA >= valB ? 0 : NaN;
          }

          //CHANGE HERE:
          function themeSort(a, b) {
            for (i = 0; i < themeOrder.length; i++) {
              if (a === themeOrder[i]) {
                var valA = i;
              }
              if (b === themeOrder[i]) {
                var valB = i;
              }
            }
            return valA < valB ? -1 : valA > valB ? 1 : valA >= valB ? 0 : NaN;
          }

          console.log(focusAreaOrder);

          //CHANGE HERE:
          var focusAreaeBandColorScale = d3
            .scaleOrdinal()
            .domain(focusAreaOrder)
            .range([
              "#5FBDFB",
              "#5FBDFB",
              "#5FBDFB",
              "#5FBDFB",
              "#EA3B66",
              "#EA3B66",
              "#EA3B66",
              "#EA3B66",
              "#F5D932",
              "#F5D932",
              "#F5D932",
              "#F5D932",
              "#F5D932",
              "#4CB944",
              "#4CB944"
            ]);


            
          /*

            function oppSpaceSort(a, b) {
              for (i = 0; i < oppSpace_order.length; i++) {
                if (a === oppSpace_order[i]) {
                  var valA = i;
                }
                if (b === oppSpace_order[i]) {
                  var valB = i;
                }
              }
              return valA < valB ? -1 : valA > valB ? 1 : valA >= valB ? 0 : NaN;
            }

            var oppSpaceBandColorScale = d3
              .scaleOrdinal()
              .domain(oppSpace_order)
              .range([
                "#63C1AF",
                "#63C1AF",
                "#63C1AF",
                "#63C1AF",
                "#311C42",
                "#311C42",
                "#E74668"
              ]); */

          // need to fix.
          var fundingCategoryDomain = [
            "Undisclosed",
            "Seed",
            "Series A",
            "Series B",
            "Series C",
            "Series D",
            "Series E",
            "Public"
          ];

          var fundingCategoryRange = [
            "Unfunded",
            "Seed",
            "Series A+",
            "Series A+",
            "Series A+",
            "Series A+",
            "Series A+",
            "Series A+"
          ];

          var fundingCategoryRangeUnique = [...new Set(fundingCategoryRange)];

          var fundingCategoryScale = d3
            .scaleOrdinal()
            .domain(fundingCategoryDomain)
            .range(fundingCategoryRange);

          var colors = ["#D75059", "#82D4BB", "#388659"];

          var nodeColorScale = d3
            .scaleOrdinal()
            .domain(fundingCategoryRangeUnique)
            .range(colors);

          var focusAreaSorted = d3
            .nest()
            .key(function(d) {
              return d["Opportunity Space"];
            })
            .sortKeys(focusAreaSort)
            .rollup(function(v) {
              var totalFunding = d3.sum(v, function(d) {
                return +d["Total \nfunding (US$)"];
              });
              return totalFunding;
            })
            .entries(data);

          console.log(focusAreaSorted);

          var count_by_focus_area = d3
            .nest()
            .key(function(d) {
              return d["Opportunity Space"];
            })
            .sortKeys(focusAreaSort)
            .entries(data);

          var count_by_themes = d3
            .nest()
            .key(function(d) {
              return d["Themes"];
            })
            .sortKeys(themeSort)
            .entries(data);

          console.log(count_by_themes);

          var count_by_maturity = d3
            .nest()
            .key(function(d) {
              return d["Maturity"];
            })
            .rollup(function(v) {
              return v.length;
            })
            .entries(data);

          var count_by_industry = d3
            .nest()
            .key(function(d) {
              return d["Industry"];
            })
            .rollup(function(v) {
              return v.length;
            })
            .entries(data);

          var count_by_funding_stage = d3
            .nest()
            .key(function(d) {
              return d["Funding \nRound"];
            })
            .rollup(function(v) {
              return v.length;
            })
            .entries(data);

          var count_by_year = d3
            .nest()
            .key(function(d) {
              return d["Founded"];
            })
            .sortKeys(d3.ascending)
            .rollup(function(v) {
              return v.length;
            })
            .entries(data);

          var yearList = [];
          count_by_year.forEach(function(d, i) {
            d.inner = 50 + (i * 250) / count_by_year.length;
            d.outer = 50 + ((i + 1) * 250) / count_by_year.length;
            yearList.push(d.key);
          });

          /* var fundingStage = [
              "Unfunded",
              "Seed",
              "Series A",
              "Series B",
              "Series C",
              "Series D",
              "Series E",
              "Public",
              "Acquired"
            ];

            var nodeSizeScale = d3
              .scaleOrdinal()
              .domain(fundingStage)
              .range([2, 2.75, 3.5, 4.25, 5, 5.2, 5.4, 5.6, 0]); */

          //var fundingAmount = ["$0-$10M", "$10-$20M", "$20M+"];

          /* var nodeSizeScale = d3
              .scaleOrdinal()
              .domain(fundingAmount)
              .range([2.6, 3.4, 4.2]);

            function nodeSizeScaleFunction(funding) {
              if (funding <= 10000000) {
                return "$0-$10M";
              }
              if (funding > 10000000 && funding <= 20000000) {
                return "$10-$20M";
              }
              if (funding > 20000000) {
                return "$20M+";
              }
            } */

          var maturity_list = [
            { name: "Existing", inner: 50, outer: 140 },
            { name: "Emerging", inner: 140, outer: 220 },
            { name: "Distant", inner: 220, outer: 300 }
          ];

          var backgroundArc = d3
            .arc()
            .innerRadius(maturity_list[0].inner)
            .outerRadius(maturity_list[2].outer);

          var existingArc = d3
            .arc()
            .innerRadius(maturity_list[0].inner)
            .outerRadius(maturity_list[0].outer);

          var emergingArc = d3
            .arc()
            .innerRadius(maturity_list[1].inner)
            .outerRadius(maturity_list[1].outer);

          var distantArc = d3
            .arc()
            .innerRadius(maturity_list[2].inner)
            .outerRadius(maturity_list[2].outer);

          var themeArc = d3
            .arc()
            .innerRadius(330)
            .outerRadius(360);

          var chartPie = d3
            .pie()
            .value(function(d) {
              return d.value.value + 2000000000000;
            })
            .sort(focusAreaSort);

          //CHANGE HERE:
          var outerChartPie = d3
            .pie()
            .value(function(d) {
              var number_of_opp_spaces = [
                ...new Set(
                  d.value.values.map(function(v) {
                    return v["Opportunity Space"];
                  })
                )
              ];
              return number_of_opp_spaces.length;
            })
            .sort(themeSort);

          var outerChartPieData = outerChartPie(d3.entries(count_by_themes));

          var chartPieData = chartPie(d3.entries(focusAreaSorted));

          var yearSegmentColorScale = d3
            .scaleOrdinal()
            .domain(yearList)
            .range(["#f4f4f4"]);

          /*         .range([
                "#F6F6F6",
                "#F0F0F0",
                "#E8E8E8",
                "#E0E0E0",
                "#DADADA",
                "#D2D2D2",
                "#C9C9C9",
                "#BDBDBD",
                "#AFAFAF",
                "#9E9E9E",
                "#868686",
                "#7A7A7A"
              ]); */

          industryList = [
            "All Startups",
            "Cement",
            "Mining",
            "Both",
            "Alternative"
          ];

          var industrySelector = d3
            .select("#industry-selector")
            .selectAll("a")
            .data(industryList)
            .enter()
            .append("text")
            .html(function(d) {
              return "<a href='#'>" + d + "</a>";
            })
            .on("click", function(d) {
              update_opacity(d);
              industryFilter = d;
            });

          var themeSegments = chartSVG
            .selectAll("theme-segments")
            .data(outerChartPieData)
            .enter()
            .append("path")
            .attr("d", themeArc)
            .attr("fill", function(d) {
              return focusAreaeBandColorScale(
                d.data.value.values[0]["Opportunity Space"]
              );
            })
            .style("opacity", "0.7")
            .style("stroke", "white")
            .style("stroke-width", "2px");

          var backgroundSegments = chartSVG
            .selectAll("background-segments")
            .data(chartPieData)
            .enter()
            .append("path")
            .attr("id", function(d) {
              return (
                "background-segment-" +
                d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
              );
            })
            .style("opacity", 0)
            .attr("d", backgroundArc);

          maturity_list.forEach(function(v) {
            var tmpArc = d3
              .arc()
              .innerRadius(v.inner)
              .outerRadius(v.outer);

            var tmpSegment = chartSVG
              .selectAll("existing-segments")
              .data(chartPieData)
              .enter()
              .append("path")
              .attr("class", "segment " + v.name.toLowerCase() + "-segments")
              .attr("id", function(d) {
                return (
                  v.name.toLowerCase() +
                  "-" +
                  d.data.value.key.replace(/ /g, "-").replace(/&/g, "and") +
                  "-segment"
                );
              })
              .attr("d", tmpArc)
              .attr("opacity", 1);
          });

          count_by_year.forEach(function(v) {
            var tmpArc = d3
              .arc()
              .innerRadius(v.inner)
              .outerRadius(v.outer);

            var tmpSegment = chartSVG
              .selectAll("year-segment")
              .data(chartPieData)
              .enter()
              .append("path")
              .attr("class", "segment " + "year-" + v.key + "-segments")
              .attr("id", function(d) {
                return (
                  "year-" +
                  v.key +
                  "-" +
                  d.data.value.key.replace(/ /g, "-").replace(/&/g, "and") +
                  "-segment"
                );
              })
              .attr("d", tmpArc)
              .attr("opacity", 0)
              .attr("fill", yearSegmentColorScale(v.key));
          });

          var numSegments = focusAreaSorted.length;

          var segmentArc = d3
            .arc()
            .innerRadius(innerRadius)
            .outerRadius(outerRadius);

          var segmentLabelArc = d3
            .arc()
            .innerRadius(outerRadius)
            .outerRadius(outerRadius * 1.05);

          var segmentLabelBandArc = d3
            .arc()
            .innerRadius(outerRadius)
            .outerRadius(outerRadius * 1.095);

          var segmentsLabelBand = chartSVG
            .selectAll("path.segment-band")
            .data(chartPieData)
            .enter()
            .append("path")
            .classed("segment-band", true)
            .attr("d", segmentLabelBandArc)
            .attr("id", function(d) {
              return (
                d.data.value.key.toLowerCase().replace(/ /g, "-") + "-band"
              );
            })
            .attr("fill", function(d) {
              return focusAreaeBandColorScale(d.data.value.key);
            })
            .on("mouseover", function(d) {
              labelMouseOver(d);
              hoverInfoFunction(d);
            })
            .on("mouseout", function(d) {
              if (hoverOn === 0) {
                labelMouseOut();
              }
            })
            .on("click", function(d) {
              if (filterKey === d.data.value.key) {
                filterKey = "";
                updateNodes("focus area", filterKey);
                d3.selectAll(".label-mouse-over-text-clicked").remove();
                d3.selectAll(".hover-svg-background-clicked").remove();
              } else {
                filterKey = d.data.value.key;
                updateNodes("focus area", filterKey);
                hoverInfoFunction(d, "-clicked");
              }
            });

          var labelRadius = outerRadius * 1.055;
          var labelOtherRadius = outerRadius * 1.02;

          var labels = chartSVG.append("g").classed("labels", true);
          var labelsOther = chartSVG.append("g").classed("labels", true);

          labels
            .append("def")
            .append("path")
            .attr("id", "label-path")
            .attr(
              "d",
              "m0 " +
                -labelRadius +
                " a" +
                labelRadius +
                " " +
                labelRadius +
                " 0 1,1 -0.01 0"
            );

          labelsOther
            .append("def")
            .append("path")
            .attr("id", "label-other-path")
            .attr(
              "d",
              "m0 " +
                -labelOtherRadius +
                " a" +
                labelOtherRadius +
                " " +
                labelOtherRadius +
                " 0 1,1 -0.01 0"
            );

          labels
            .selectAll("text")
            .data(chartPieData)
            .enter()
            .append("text")
            .attr("class", "label-text")
            .append("textPath")
            .attr("xlink:href", "#label-path")
            .attr("startOffset", function(d, i) {
              var percentage =
                ((d.endAngle - d.startAngle) / 2 + d.startAngle) / 0.0628319;
              return percentage + "%";
            })
            .text(function(d) {
              return label_wrap(d.data.value.key.toUpperCase())[0];
            });

          labelsOther
            .selectAll("text")
            .data(chartPieData)
            .enter()
            .append("text")
            .attr("class", "label-text")
            .append("textPath")
            .attr("xlink:href", "#label-other-path")
            .attr("startOffset", function(d, i) {
              var percentage =
                ((d.endAngle - d.startAngle) / 2 + d.startAngle) / 0.0628319;
              return percentage + "%";
            })
            .text(function(d) {
              var result = label_wrap(d.data.value.key.toUpperCase());
              if (result.length > 2) {
                return result[1] + " " + result[2];
              } else {
                return result[1];
              }
            });

          var labelThemeRadius = outerRadius + 40;

          var labelsTheme = chartSVG.append("g").classed("labels-theme", true);

          labelsTheme
            .append("def")
            .append("path")
            .attr("id", "labels-theme-path")
            .attr(
              "d",
              "m0 " +
                -labelThemeRadius +
                " a" +
                labelThemeRadius +
                " " +
                labelThemeRadius +
                " 0 1,1 -0.01 0"
            );

          labelsTheme
            .selectAll("text")
            .data(outerChartPieData)
            .enter()
            .append("text")
            .attr("class", "labels-theme-text")
            .append("textPath")
            .attr("xlink:href", "#labels-theme-path")
            .attr("startOffset", function(d, i) {
              var percentage =
                ((d.endAngle - d.startAngle) / 2 + d.startAngle) / 0.0628319;
              return percentage + "%";
            })
            .text(function(d) {
              return d.data.value.key.toUpperCase();
            });

          /* var key = keySVG
              .selectAll("g.key")
              .data(fundingAmount)
              .enter()
              .append("g")
              .attr("transform", function(d, i) {
                var h = keySize + keySpacing;
                var offset = 80;
                var horz = -45;
                var vert = i * h - offset;
                return "translate(" + horz + "," + vert + ")";
              });

            key
              .append("circle")
              .classed("key-item", true)
              .attr("r", function(d) {
                return nodeSizeScale(d);
              })
              .on("mouseover", function(d) {
                keyMouseOver(d, "size");
              })
              .on("mouseout", keyMouseOut);

            key
              .append("text")
              .text(function(d) {
                return d;
              })
              .classed("key-labels key-label", true)
              .attr("dx", "1.8em")
              .attr("dy", "0.25em")
              .on("mouseover", function(d) {
                keyMouseOver(d, "size");
              })
              .on("mouseout", keyMouseOut); */

          var keyOther = keySVG
            .selectAll("g.key-other")
            .data(fundingCategoryRangeUnique)
            .enter()
            .append("g")
            .attr("transform", function(d, i) {
              var h = keySize + keySpacing;
              var offset = 0;
              var horz = -50;
              var vert = i * h - offset + 120;
              return "translate(" + horz + "," + vert + ")";
            });

          var keyAcquired = keySVG
            .append("g")
            .attr("transform", "translate(-45,180)");

          keyAcquired
            .append("rect")
            .classed("key-item-other", true)
            .attr("width", 8.8)
            .attr("height", 8.8)
            .attr("fill", "#FFFD82")
            .attr("x", -4)
            .attr("y", 3)
            .attr("transform", "translate(0, -7) rotate(45)")
            .on("mouseover", function(d) {
              keyMouseOver("Acquired", "acquired");
            })
            .on("mouseout", keyMouseOut)
            .on("click", function(d) {
              if (filterKey === "acquired") {
                filterKey = "";
                updateNodes("key", filterKey);
              } else {
                filterKey = "acquired";
                updateNodes("key", filterKey);
              }
            });

          keyAcquired
            .append("text")
            .text("Acquired")
            .classed("key-labels key-label", true)
            .attr("dx", "1.3em")
            .attr("dy", "0.2em")
            .on("mouseover", function() {
              keyMouseOver("Acquired", "acquired");
            })
            .on("mouseout", keyMouseOut)
            .on("click", function(d) {
              if (filterKey === "acquired") {
                filterKey = "";
                updateNodes("key", filterKey);
              } else {
                filterKey = "acquired";
                updateNodes("key", filterKey);
              }
            });

          keyOther
            .append("circle")
            .classed("key-item-other", true)
            .attr("r", 4.4)
            .attr("fill", function(d) {
              return nodeColorScale(d);
            })
            .on("mouseover", function(d) {
              keyMouseOver(d, "color");
            })
            .on("mouseout", keyMouseOut)
            .on("click", function(d) {
              if (filterKey === d) {
                filterKey = "";
                updateNodes("key", filterKey);
              } else {
                filterKey = d;
                updateNodes("key", filterKey);
              }
            });

          keyOther
            .append("text")
            .text(function(d) {
              return d;
            })
            .classed("key-labels key-label", true)
            .attr("dx", "1.8em")
            .attr("dy", "0.35em")
            .on("mouseover", function(d) {
              keyMouseOver(d, "color");
            })
            .on("mouseout", keyMouseOut)
            .on("click", function(d) {
              if (filterKey === d) {
                filterKey = "";
                updateNodes("key", filterKey);
              } else {
                filterKey = d;
                updateNodes("key", filterKey);
              }
            });

          keyActivity = keySVG
            .append("g")
            .attr("transform", "translate(-50,140)")
            .style("display", "none");

          keyActivity
            .append("polygon")
            .classed("key-item-other", true)
            .attr("id", "activity-key")
            .attr("points", [
              [0, -4.7],
              [-4.2, 3.7],
              [4.2, 3.7]
            ])
            .attr("dy", -10)
            .attr("dx", 10)
            .attr("fill", "#7C436A")
            .attr("opacity", function() {
              if (filterKey === "") {
                return 1;
              } else {
                return 0.3;
              }
            })
            .on("mouseover", function() {
              keyMouseOver("", "activity");
            })
            .on("mouseout", keyMouseOut)
            .on("click", function() {
              if (filterKey === "activity") {
                filterKey = "";
                updateNodes("", filterKey);
              } else {
                filterKey = "activity";
                updateNodes("", filterKey);
              }
            });

          keyActivity
            .append("text")
            .text("Activity")
            .classed("key-labels key-label", true)
            .attr("id", "activity-key-label")
            .attr("dx", "1.8em")
            .attr("dy", "0.3em")
            .attr("opacity", function() {
              if (filterKey === "") {
                return 1;
              } else {
                return 0.3;
              }
            })
            .on("mouseover", function() {
              keyMouseOver("", "activity");
            })
            .on("mouseout", keyMouseOut)
            .on("click", function() {
              if (filterKey === "activity") {
                filterKey = "";
                updateNodes("", filterKey);
              } else {
                filterKey = "activity";
                updateNodes("", filterKey);
              }
            });

          keyInvestment = keySVG
            .append("g")
            .attr("transform", "translate(-50,120)")
            .style("display", "none");

          keyInvestment
            .append("circle")
            .classed("key-item-other", true)
            .attr("id", "investment-key")
            .attr("cx", 0)
            .attr("cy", 0)
            .attr("r", 4.4)
            .attr("dy", -10)
            .attr("dx", 10)
            .attr("fill", "none")
            .attr("opacity", function() {
              if (filterKey === "") {
                return 1;
              } else {
                return 0.3;
              }
            });

          keyInvestment
            .append("text")
            .text("Investment")
            .classed("key-labels key-label", true)
            .attr("id", "investment-key-label")
            .attr("dx", "1.8em")
            .attr("dy", "0.3em")
            .attr("opacity", function() {
              if (filterKey === "") {
                return 1;
              } else {
                return 0.3;
              }
            });

          var keyTitle = keySVG
            .append("text")
            .attr("class", "key-title")
            .text("Funding Key:")
            .attr("y", function() {
              return keyOther.node().transform.animVal.getItem(0).matrix.f - 16;
            })
            .attr("x", -58);

          /* var switchBtn = svg
              .append("rect")
              .attr("id", "switch-button")
              .attr("x", width / 2 - 45)
              .attr("y", function() {
                return (
                  keyAcquired.node().transform.animVal.getItem(0).matrix.f + 36
                );
              })
              .attr("width", 90)
              .attr("height", 30)
              .on("click", function() {
                switchRadial();
              });

            var switchBtnLabel = svg
              .append("text")
              .attr("id", "switch-button-label")
              .attr("x", width / 2)
              .attr("y", function() {
                return +d3.select("#switch-button").attr("y") + 20;
              })
              .text("Maturity")
              .attr("fill", "white"); */

          var existingLabelRadius = maturity_list[0].outer - 15;
          var emergingLabelRadius = maturity_list[1].outer - 15;
          var distantLabelRadius = maturity_list[2].outer - 15;

          var existingLabel = chartSVG
            .append("g")
            .classed("maturity-labels", true);

          existingLabel
            .append("def")
            .append("path")
            .attr("id", "existing-label-path")
            .attr(
              "d",
              "m " +
                -existingLabelRadius +
                " 0 a 50 50 0 1 1 " +
                2 * existingLabelRadius +
                " 0"
            );

          existingLabel
            .append("text")
            .attr("class", "maturity-label-text")
            .attr("id", "existing-label-path-text")
            .append("textPath")
            .attr("xlink:href", "#existing-label-path")
            .attr("startOffset", "50%")
            .text("Existing");

          var emergingLabel = chartSVG
            .append("g")
            .classed("maturity-labels", true);

          emergingLabel
            .append("def")
            .append("path")
            .attr("id", "emerging-label-path")
            .attr(
              "d",
              "m " +
                -emergingLabelRadius +
                " 0 a 50 50 0 1 1 " +
                2 * emergingLabelRadius +
                " 0"
            );

          emergingLabel
            .append("text")
            .attr("class", "maturity-label-text")
            .attr("id", "emerging-label-path-text")
            .append("textPath")
            .attr("xlink:href", "#emerging-label-path")
            .attr("startOffset", "50%")
            .text("Emerging");

          count_by_year.forEach(function(d, i) {
            this["year" + d.key + "LabelRadius"] = d.outer - 10;

            this["year" + d.key + "Label"] = chartSVG
              .append("g")
              .classed("year-labels", true);

            this["year" + d.key + "Label"]
              .append("def")
              .append("path")
              .attr("id", "year-" + d.key + "-label-path")
              .attr(
                "d",
                "m " +
                  -this["year" + d.key + "LabelRadius"] +
                  " 0 a 50 50 0 1 1 " +
                  2 * this["year" + d.key + "LabelRadius"] +
                  " 0"
              );
            d.fn = this["year" + d.key + "Label"];
          });

          var distantLabel = chartSVG
            .append("g")
            .classed("maturity-labels", true);

          distantLabel
            .append("def")
            .append("path")
            .attr("id", "distant-label-path")
            .attr(
              "d",
              "m " +
                -distantLabelRadius +
                " 0 a 50 50 0 1 1 " +
                2 * distantLabelRadius +
                " 0"
            );

          distantLabel
            .append("text")
            .attr("class", "maturity-label-text")
            .attr("id", "distant-label-path-text")
            .append("textPath")
            .attr("xlink:href", "#distant-label-path")
            .attr("startOffset", "50%")
            .text("Distant");

          maturity_list_elements = [
            { name: "Existing", fn: existingLabel },
            { name: "Emerging", fn: emergingLabel },
            { name: "Distant", fn: distantLabel }
          ];

          maturity_list.forEach(function(d) {
            var id = "#" + d.name.toLowerCase() + "-label-path-text";
            d3.select(id).remove();
          });

          count_by_year.forEach(function(d) {
            d.fn
              .append("text")
              .attr("class", "year-label-text")
              .attr("id", "year-" + d.key + "-label-path-text")
              .append("textPath")
              .attr("xlink:href", "#year-" + d.key + "-label-path")
              .attr("startOffset", "50%")
              .text(d.key);

            chartPieData.forEach(function(v) {
              d3.select(
                "#year-" +
                  d.key +
                  "-" +
                  v.data.value.key.replace(/ /g, "-").replace(/&/g, "and") +
                  "-segment"
              ).attr("opacity", 1);
            });
          });

          var nodeSecondData = d3
            .nest()
            .key(function(d) {
              return d["Opportunity Space"];
            })
            .key(function(d) {
              return d["Founded"];
            })
            .rollup(function(v) {
              return v.length;
            })
            .entries(data);

          var nodeThirdData = d3
            .nest()
            .key(function(d) {
              return d["Opportunity Space"];
            })
            .key(function(d) {
              return d["Founded"];
            })
            .rollup(function(v) {
              return v.length;
            })
            .entries(data);

          console.log(nodeThirdData);

          var nodeList = [];

          var nodeSecondList = [];
          data.forEach(function(d) {
            //console.log(d)
            for (i = 0; i < chartPieData.length; i++) {
              if (d["Opportunity Space"] === chartPieData[i].data.value.key) {
                var tmp_startAngleMin = chartPieData[i].startAngle + 0.025;
                var tmp_endAngleMax = chartPieData[i].endAngle - 0.025;
                break;
              }
            }

            for (i = 0; i < count_by_year.length; i++) {
              if (d["Founded"] === count_by_year[i].key) {
                //console.log('InnerRadius:', count_by_year[i]['inner'])
                //console.log('OuterRadius:', count_by_year[i]['outer'])
                tmp_innerRadiusMin = count_by_year[i]["inner"] + 6;
                tmp_outerRadiusMax = count_by_year[i]["outer"] - 6;
                break;
              }
            }
            for (i = 0; i < nodeSecondData.length; i++) {
              if (nodeSecondData[i].key === d["Opportunity Space"]) {
                for (j = 0; j < nodeSecondData[i].values.length; j++) {
                  if (nodeSecondData[i].values[j].key === d["Founded"]) {
                    var results = assignRandom(
                      tmp_startAngleMin,
                      tmp_endAngleMax,
                      tmp_innerRadiusMin,
                      tmp_outerRadiusMax,
                      nodeSecondList
                    );
                  }
                }
              }
            }
            d.yearX = results[0];
            d.yearY = results[1];
          });
          /*
            var nodeThirdList = [];
              data.forEach(function(d) {
                //console.log(d)
                for (i = 0; i < chartPieData.length; i++) {
                  if (d["Focus Area"] === chartPieData[i].data.value.key) {
                    var tmp_startAngleMin = chartPieData[i].startAngle + 0.025;
                    var tmp_endAngleMax = chartPieData[i].endAngle - 0.025;
                    break;
                  }
                }

                for (i = 0; i < count_by_year.length; i++) {
                  if (d["Founded"] === count_by_year[i].key) {
                    //console.log('InnerRadius:', count_by_year[i]['inner'])
                    //console.log('OuterRadius:', count_by_year[i]['outer'])
                    tmp_innerRadiusMin = count_by_year[i]["inner"] + 6;
                    tmp_outerRadiusMax = count_by_year[i]["outer"] - 6;
                    break;
                  }
                }
                for (i = 0; i < nodeThirdData.length; i++) {
                  if (nodeThirdData[i].key === d["Focus Area"]) {
                    for (j = 0; j < nodeThirdData[i].values.length; j++) {
                      if (nodeThirdData[i].values[j].key === d["Founded"]) {
                        var results = assignRandom(
                          tmp_startAngleMin,
                          tmp_endAngleMax,
                          tmp_innerRadiusMin,
                          tmp_outerRadiusMax,
                          nodeThirdList
                        );
                      }
                    }
                  }
                }
                d.yearX = results[0];
                d.yearY = results[1];
              });
              */

          //switchRadial();


          var CompetitorMode = 0;

          var nodes = chartSVG
            .selectAll("nodes")
            .data(data)
            .enter()
            .append("a")
            .attr("xlink:href", function(d) {
              return d.URL;
            })
            .attr("target", "_blank")
            .append("circle")
            .each(function(d) {
              d.hide = false;
            })
            .attr("class", "nodes")
            .attr("r", function(d) {
              
              if (
                d["Funding \nRound"] !== "Acquired"
              ) {
                console.log(d)
                return 2.4;
              }
            })
            .attr("cx", function(d) {
              return d.yearX;
            })
            .attr("cy", function(d) {
              return d.yearY;
            })
            .attr("fill", function(d) {
              return nodeColorScale(fundingCategoryScale(d["Funding \nRound"]));
            })
            .on("mouseover", function(d) {
              nodeMouseOver(d);
            })
            .on("mouseout", nodeMouseOut);

          var nodes_activity = chartSVG
            .selectAll("nodes-activity")
            .data(data)
            .enter()
            .append("a")
            .attr("xlink:href", function(d) {
              return d.URL;
            })
            .attr("target", "_blank")
            .append("polygon")
            .attr("class", "nodes nodes-activity")
            .attr("id", function(d) {
              return d["Startup"].toLowerCase().replace(/ /g, "-");
            })
            .attr("points", function(d) {
              var points = [
                [d.yearX, d.yearY],
                [d.yearX, d.yearY],
                [d.yearX, d.yearY]
              ];
              return points;
            })
            .attr("fill", "#7C436A")
            .on("mouseover", function(d) {
              nodeMouseOver(d);
            })
            .on("mouseout", nodeMouseOut);

          var nodes_acquired = chartSVG
            .selectAll("nodes-acquired")
            .data(data)
            .enter()
            .append("a")
            .attr("xlink:href", function(d) {
              return d.URL;
            })
            .attr("target", "_blank")
            .append("rect")
            .attr("class", "nodes nodes-acquired")
            .attr("id", function(d) {
              return d["Startup"].toLowerCase().replace(/ /g, "-");
            })
            .attr("width", function(d) {
              if (d["Funding \nRound"] === "Acquired") {
                return 8.8;
              } else {
                return 0;
              }
            })
            .attr("height", function(d) {
              if (d["Funding \nRound"] === "Acquired") {
                return 8.8;
              } else {
                return 0;
              }
            })
            .attr("x", 0)
            .attr("y", 0)
            .attr("fill", "#FFFD82")
            .attr("transform", function(d) {
              return "translate(" + d.yearX + "," + d.yearY + ")    rotate(45)";
            })
            .on("mouseover", function(d) {
              nodeMouseOver(d);
            })
            .on("mouseout", nodeMouseOut);

          /* function keyMouseOver(data, type) {
              nodes.attr("opacity", function(d) {
                if (nodeSizeScaleFunction(d["$ Total Funding "]) === data) {
                  return 1;
                } else {
                  return 0.3;
                }
              });
              nodes_acquired.attr("opacity", 0.3);
            } */

          function updateNodes(type, filterKey) {
            if (filterKey === "") {
              data.forEach(function(d) {
                d.opacity = 1;
              });
              nodes.attr("opacity", 1);
              nodes_acquired.attr("opacity", 1);
              nodes_activity.attr("opacity", 1);
              keyOther.attr("opacity", 1);
              keyAcquired.attr("opacity", 1);
              segmentsLabelBand.attr("opacity", function(d) {
                d.opacity = 1;
                return d.opacity;
              });
              keyActivity.attr("opacity", 1);
            }

            if (filterKey === "acquired") {
              nodes.attr("opacity", function(d) {
                if (d["Funding \nRound"] !== "Acquired") {
                  d.opacity = 0.3;
                }
                return d.opacity;
              });

              nodes_acquired.attr("opacity", function(d) {
                if (d["Funding \nRound"] === "Acquired") {
                  d.opacity = 1;
                }
                return d.opacity;
              });

              nodes_activity.attr("opacity", function(d) {
                if (d["Funding \nRound"] !== "Acquired") {
                  d.opacity = 0.3;
                }
                return d.opacity;
              });

              keyOther.attr("opacity", 0.3);

              keyAcquired.attr("opacity", 1);

              keyActivity.attr("opacity", 0.3);
            }

            if (filterKey === "activity") {
              nodes.attr("opacity", function(d) {
                if (
                  d["Activity/Acquisition Time"] != "" &&
                  d["Funding \nRound"] !== "Acquired"
                ) {
                  d.opacity = 1;
                } else {
                  d.opacity = 0.3;
                }
                return d.opacity;
              });

              nodes_activity.attr("opacity", function(d) {
                if (d["Activity/Acquisition Time"] != "") {
                  d.opacity = 1;
                } else {
                  d.opacity = 0.3;
                }
                return d.opacity;
              });

              nodes_acquired.attr("opacity", function(d) {
                if (d["Activity/Acquisition Time"] != "") {
                  d.opacity = 1;
                } else {
                  d.opacity = 0.3;
                }
                return d.opacity;
              });
              keyOther.attr("opacity", 0.3);

              keyAcquired.attr("opacity", 0.3);

              keyActivity.attr("opacity", 1);
            }

            if (
              filterKey !== "acquired" &&
              filterKey !== "" &&
              type === "key"
            ) {
              nodes.attr("opacity", function(v) {
                if (fundingCategoryScale(v["Funding \nRound"]) === filterKey) {
                  v.opacity = 1;
                } else {
                  v.opacity = 0.3;
                }
                return v.opacity;
              });

              nodes_acquired.attr("opacity", function(d) {
                if (d["Funding \nRound"] === "Acquired") {
                  d.opacity = 0.3;
                }
                return d.opacity;
              });

              nodes_activity.attr("opacity", function(d) {
                if (d["Activity/Acquisition Time"] != "") {
                  d.opacity = 0.3;
                }
                return d.opacity;
              });

              keyOther.attr("opacity", function(d) {
                if (d === filterKey) {
                  return 1;
                } else {
                  return 0.3;
                }
              });

              keyAcquired.attr("opacity", 0.3);

              keyActivity.attr("opacity", 0.3);
            }
            if (type === "focus area" && filterKey !== "") {
              nodes.attr("opacity", function(d) {
                if (d["Opportunity Space"].toLowerCase() !== filterKey) {
                  d.opacity = 0.3;
                } else {
                  d.opacity = 1;
                }
                return d.opacity;
              });

              nodes_acquired.attr("opacity", function(d) {
                if (d["Opportunity Space"].toLowerCase() !== filterKey) {
                  d.opacity = 0.3;
                } else {
                  d.opacity = 1;
                }
                return d.opacity;
              });

              //segment_data.data.value.key
              segmentsLabelBand.attr("opacity", function(d) {
                if (d.data.value.key === filterKey) {
                  d.opacity = 1;
                } else {
                  d.opacity = 0.3;
                }
                return d.opacity;
              });
            }
          }

          function switch_competitors() {
            if (CompetitorMode === 1) {
              keyOther.style("display", "none");
              keyInvestment.style("display", "");
              keyActivity.style("display", "");
              keyAcquired.attr("transform", "translate(-45,161)");
            } else {
              keyActivity.style("display", "none");
              keyInvestment.style("display", "none");
              keyOther.style("display", "");
              keyAcquired.attr("transform", "translate(-45,180)");
            }

            nodes
              .transition()
              .duration(animationDuration * 0.7)
              .attrTween("r", function(d) {
                var startR = d3.select(this).attr("r");
                if (
                  (d["Competitor"] === "" || d["Competitor Category"] != "") &&
                  CompetitorMode === 1
                ) {
                  d.hide = true;
                }
                if (CompetitorMode === 0) {
                  d.hide = false;
                }
                if (
                  d.hide === true ||
                  d["Funding \nRound"] === "Acquired" ||
                  d["Competitor Category"] != ""
                ) {
                  endR = 0;
                } else {
                  endR = 3.4;
                }
                var i = d3.interpolate(startR, endR);
                return function(t) {
                  return i(t);
                };
              });

            nodes_activity
              .transition()
              .duration(animationDuration * 0.7)
              .attrTween("points", function(d) {
                var currentPoints = d3.select(this).attr("points");
                var pList = currentPoints.split(",");
                var startPoints = [
                  [+pList[0], +pList[1]],
                  [+pList[2], +pList[3]],
                  [+pList[4], +pList[5]]
                ];
                if (radial === "maturity") {
                  if (
                    d["Competitor Category"] == "Activity" &&
                    CompetitorMode === 1
                  ) {
                    var endPoints = [
                      [d.x, d.y - 4.7],
                      [d.x - 4.2, d.y + 3.7],
                      [d.x + 4.2, d.y + 3.7]
                    ];
                  } else {
                    var endPoints = [
                      [d.x, d.y],
                      [d.x, d.y],
                      [d.x, d.y]
                    ];
                  }
                } else {
                  if (
                    d["Competitor Category"] == "Activity" &&
                    CompetitorMode === 1
                  ) {
                    var endPoints = [
                      [d.yearX, d.yearY - 4.7],
                      [d.yearX - 4.2, d.yearY + 3.7],
                      [d.yearX + 4.2, d.yearY + 3.7]
                    ];
                  } else {
                    var endPoints = [
                      [d.yearX, d.yearY],
                      [d.yearX, d.yearY],
                      [d.yearX, d.yearY]
                    ];
                  }
                }

                var i = d3.interpolateArray(startPoints, endPoints);
                return function(t) {
                  return i(t);
                };
              });

            nodes_acquired
              .transition()
              .duration(animationDuration * 0.7)
              .attrTween("width", function(d) {
                var startWidth = d3.select(this).attr("width");
                if (d.hide === true || d["Funding \nRound"] !== "Acquired") {
                  endWidth = 0;
                } else {
                  endWidth = 8.8;
                }
                var i = d3.interpolate(startWidth, endWidth);
                return function(t) {
                  return i(t);
                };
              })
              .attrTween("height", function(d) {
                var startHeight = d3.select(this).attr("height");
                if (d.hide === true || d["Funding \nRound"] !== "Acquired") {
                  endHeight = 0;
                } else {
                  endHeight = 8.8;
                }
                var i = d3.interpolate(startHeight, endHeight);
                return function(t) {
                  return i(t);
                };
              })
              .attrTween("y", function(d) {
                var startY = d3.select(this).attr("y");
                if (d.hide === true || d["Funding \nRound"] !== "Acquired") {
                  endY = 7;
                } else {
                  endY = 0;
                }
                var i = d3.interpolate(startY, endY);
                return function(t) {
                  return i(t);
                };
              });
          }

          function update_opacity(type) {
            // delete later when you change to industry

            nodes
              .transition()
              .duration(animationDuration * 0.7)
              .attrTween("r", function(d) {
                var startR = d3.select(this).attr("r");
                if (
                  (d["Industry"] === type || type === "All Startups") &&
                  d["Funding \nRound"] !== "Acquired" &&
                  d.hide === false
                ) {
                  var endR = 3.4;
                } else {
                  var endR = 0;
                }
                var i = d3.interpolate(startR, endR);
                return function(t) {
                  return i(t);
                };
              });

            nodes_activity
              .transition()
              .duration(animationDuration * 0.7)
              .attrTween("points", function(d) {
                var currentPoints = d3.select(this).attr("points");
                var pList = currentPoints.split(",");
                var startPoints = [
                  [+pList[0], +pList[1]],
                  [+pList[2], +pList[3]],
                  [+pList[4], +pList[5]]
                ];

                if (
                  d["Activity/Acquisition Time"] != "" &&
                  CompetitorMode === 1 &&
                  (d["Industry"] === type || type === "All Startups")
                ) {
                  var endPoints = [
                    [d.x, d.y - 4.7],
                    [d.x - 4.2, d.y + 3.7],
                    [d.x + 4.2, d.y + 3.7]
                  ];
                } else {
                  var endPoints = [
                    [d.x, d.y],
                    [d.x, d.y],
                    [d.x, d.y]
                  ];
                }
                var i = d3.interpolateArray(startPoints, endPoints);
                return function(t) {
                  return i(t);
                };
              });

            nodes_acquired
              .transition()
              .duration(animationDuration * 0.7)
              .attrTween("width", function(d) {
                var startWidth = d3.select(this).attr("width");
                if (
                  (d["Industry"] === type || type === "All Startups") &&
                  d["Funding \nRound"] === "Acquired" &&
                  d.hide === false
                ) {
                  var endWidth = 8.8;
                } else {
                  var endWidth = 0;
                }
                var i = d3.interpolate(startWidth, endWidth);
                return function(t) {
                  return i(t);
                };
              })
              .attrTween("height", function(d) {
                var startHeight = d3.select(this).attr("height");
                if (
                  (d["Industry"] === type || type === "All Startups") &&
                  d["Funding \nRound"] === "Acquired" &&
                  d.hide === false
                ) {
                  var endHeight = 8.8;
                } else {
                  var endHeight = 0;
                }
                var i = d3.interpolate(startHeight, endHeight);
                return function(t) {
                  return i(t);
                };
              })
              .attrTween("y", function(d) {
                var startY = d3.select(this).attr("y");
                if (
                  (d["Industry"] === type || type === "All Startups") &&
                  d["Funding \nRound"] === "Acquired" &&
                  d.hide === false
                ) {
                  var endY = 0;
                } else {
                  var endY = 7;
                }
                var i = d3.interpolate(startY, endY);
                return function(t) {
                  return i(t);
                };
              });
          }

          /*
          function switchRadial() {
            if (radial === "maturity") {
              radial = "year";

              nodes
                .transition()
                .duration(animationDuration)
                .attrTween("cx", function(d) {
                  var i = d3.interpolate(d.x, d.yearX);
                  return function(t) {
                    return i(t);
                  };
                })
                .attrTween("cy", function(d) {
                  var i = d3.interpolate(d.y, d.yearY);
                  return function(t) {
                    return i(t);
                  };
                });

              nodes_activity
                .transition()
                .duration(animationDuration)
                .attrTween("transform", function(d) {
                  var i = d3.interpolate(d.x - d.yearX, 0);
                  var j = d3.interpolate(d.y - d.yearY, 0);
                  return function(t) {
                    return "translate(" + i(t) + "," + j(t) + ")";
                  };
                });

              nodes_acquired
                .transition()
                .duration(animationDuration)
                .attrTween("transform", function(d) {
                  var i = d3.interpolate(d.x, d.yearX);
                  var j = d3.interpolate(d.y, d.yearY);
                  return function(t) {
                    return "translate(" + i(t) + "," + j(t) + ") rotate(45)";
                  };
                });

              maturity_list.forEach(function(d) {
                var id = "#" + d.name.toLowerCase() + "-label-path-text";
                d3.select(id).remove();
              });

              count_by_year.forEach(function(d) {
                d.fn
                  .append("text")
                  .attr("class", "year-label-text")
                  .attr("id", "year-" + d.key + "-label-path-text")
                  .append("textPath")
                  .attr("xlink:href", "#year-" + d.key + "-label-path")
                  .attr("startOffset", "50%")
                  .text(d.key);

                chartPieData.forEach(function(v) {
                  d3.select(
                    "#year-" +
                      d.key +
                      "-" +
                      v.data.value.key.replace(/ /g, "-").replace(/&/g, "and") +
                      "-segment"
                  ).attr("opacity", 1);
                });
              });
            } else {
              radial = "maturity";

              d3.select("#switch-button-year").style(
                "background-color",
                "#8e8e8e"
              );
              d3.select("#switch-button-maturity").style(
                "background-color",
                "#e74668"
              );

              nodes
                .transition()
                .duration(animationDuration)
                .attrTween("cx", function(d) {
                  var i = d3.interpolate(d.yearX, d.x);
                  return function(t) {
                    return i(t);
                  };
                })
                .attrTween("cy", function(d) {
                  var i = d3.interpolate(d.yearY, d.y);
                  return function(t) {
                    return i(t);
                  };
                });

              nodes_activity
                .transition()
                .duration(animationDuration)
                .attrTween("transform", function(d) {
                  var i = d3.interpolate(0, d.x - d.yearX);
                  var j = d3.interpolate(0, d.y - d.yearY);
                  return function(t) {
                    return "translate(" + i(t) + "," + j(t) + ")";
                  };
                });

              nodes_acquired
                .transition()
                .duration(animationDuration)
                .attrTween("transform", function(d) {
                  var i = d3.interpolate(d.yearX, d.x);
                  var j = d3.interpolate(d.yearY, d.y);
                  return function(t) {
                    return "translate(" + i(t) + "," + j(t) + ") rotate(45)";
                  };
                });

              count_by_year.forEach(function(d) {
                var id = "#year-" + d.key + "-label-path-text";
                d3.select(id).remove();
                chartPieData.forEach(function(v) {
                  d3.select(
                    "#year-" +
                      d.key +
                      "-" +
                      v.data.value.key.replace(/ /g, "-").replace(/&/g, "and") +
                      "-segment"
                  ).attr("opacity", 0);
                });
              });

              maturity_list_elements.forEach(function(d, i) {
                d.fn
                  .append("text")
                  .attr("class", "maturity-label-text")
                  .attr("id", d.name.toLowerCase() + "-label-path-text")
                  .append("textPath")
                  .attr(
                    "xlink:href",
                    "#" + d.name.toLowerCase() + "-label-path"
                  )
                  .attr("startOffset", "50%")
                  .text(d.name);
              });
            }
          } */

          function dateForMode(data) {
            if (
              CompetitorMode === 0 ||
              data["Competitor Categor  y"] !== "Activity"
            ) {
              return data.Founded;
            } else {
              return data["Activity/Acquisition Time"];
            }
          }

          function text_wrap(entry) {
            console.log(entry)
            limit = 20;
            entryList = entry.split(/\s+/);
            lines = [];
            current_seq_len = 0;
            current_seq = [];
            for (i = 0; i < entryList.length; i++) {
              current_seq_len += entryList[i].length;
              current_seq.push(entryList[i].replace(//g, "'"));
              if (current_seq_len > limit) {
                lines.push(current_seq);
                current_seq_len = 0;
                current_seq = [];
              }
            }
            lines.push(current_seq);
            results = "";
            x = 0;
            for (i = 0; i < lines.length; i++) {
              tmp = "";
              for (j = 0; j < lines[i].length; j++) {
                if (j !== lines[i].length - 1) {
                  tmp += lines[i][j] + " ";
                } else {
                  tmp += lines[i][j];
                }
              }
              results +=
                "<tspan x=" +
                x +
                " dy='1.1em' class='funding-hover-info'>" +
                tmp +
                "</tspan>";
            }
            return results;
          }

          function hoverInfoFunction(segment_data, clicked = "") {
            var segmentDesc;

            desc.forEach(function(v) {
              if (
                segment_data.data.value.key ===
                v["Opportunity Space"].toLowerCase().replace(/\//g, "_")
              ) {
                segmentDesc = v.Description;
              }
            });

            descFormatted = text_wrap(segmentDesc);
            hoverSVG
              .append("rect")
              .attr("width", 200)
              .attr("height", height)
              .attr("fill", "white")
              .attr("x", -100)
              .attr("y", -height / 2)
              .attr("id", "hover-svg-background" + clicked)
              .attr("class", "hover-svg-background" + clicked);
            hoverSVG
              .append("text")
              .attr("id", "label-mouse-over-text" + clicked)
              .attr("class", "hover-svg-background" + clicked)
              .attr("y", -5)
              .html(function() {
                var x = 0;
                var numberOfStartups = 0;
                var segmentFunding = 0;
                for (i = 0; i < count_by_focus_area.length; i++) {
                  if (
                    count_by_focus_area[i].key === segment_data.data.value.key
                  ) {
                    numberOfStartups = count_by_focus_area[i].values.length;
                    theme = count_by_focus_area[i].values[0]["Themes"];
                    themeDesc =
                      count_by_focus_area[i].values[0]["Theme Definition"];
                    segmentFunding = d3.sum(
                      count_by_focus_area[i].values,
                      function(d) {
                        return d["Total \nfunding (US$)"];
                      }
                    );
                  }
                }
                if (numberOfStartups === 0) {
                  var avgFunding = 0;
                } else {
                  var avgFunding = segmentFunding / numberOfStartups;
                }
                themeDesc = text_wrap(themeDesc);

                line0 =
                  "<tspan x=" +
                  x +
                  " dy='1.1em' class='funding-hover-info title'>" +
                  capitalize_sentence(segment_data.data.value.key) +
                  "</tspan>";
                lineDesc =
                  "<tspan x=" +
                  x +
                  " dy='1.7em' class='funding-hover-info'>" +
                  segmentDesc +
                  "</tspan>";
                line1 =
                  "<tspan x=" +
                  x +
                  " dy='1.7em' class='funding-hover-info'>Total Funding:</tspan>";
                line2 =
                  "<tspan x=" +
                  x +
                  " dy='1.1em' class='funding-hover-info amount'>$" +
                  formatFunding(segmentFunding) +
                  "</tspan>";
                line3 =
                  "<tspan x=" +
                  x +
                  " dy='1.7em' class='funding-hover-info'>Total Number of Startups:</tspan>";
                line4 =
                  "<tspan x=" +
                  x +
                  " dy='1.1em' class='funding-hover-info amount'>" +
                  numberOfStartups +
                  "</tspan>";
                line5 =
                  "<tspan x=" +
                  x +
                  " dy='1.7em' class='funding-hover-info'>Average Funding:</tspan>";
                line6 =
                  "<tspan x=" +
                  x +
                  " dy='1.1em' class='funding-hover-info amount'>$" +
                  formatFunding(avgFunding) +
                  "</tspan>";
                line7 =
                  "<tspan x=" +
                  x +
                  " dy='1.7em' class='funding-hover-info'>Theme:</tspan>";
                line8 =
                  "<tspan x=" +
                  x +
                  " dy='1.1em' class='funding-hover-info'>" +
                  theme +
                  "</tspan>";
                line9 =
                  "<tspan x=" +
                  x +
                  " dy='1.7em' class='funding-hover-info'>Theme Definition:</tspan>";
                line10 =
                  "<tspan x=" +
                  x +
                  " dy='1.7em' class='funding-hover-info'>" +
                  themeDesc +
                  "</tspan>";
                return (
                  line0 +
                  descFormatted +
                  line1 +
                  line2 +
                  line3 +
                  line4 +
                  line5 +
                  line6 +
                  line7 +
                  line8 +
                  line9 +
                  line10
                );
              });

            segmentsLabelBand.attr("opacity", function(d) {
              if (d.data.key === segment_data.data.key) {
                return 1;
              } else {
                return 0.3;
              }
            });
          }

          function labelMouseOver(segment_data) {
            var count_by_focus_area = d3
              .nest()
              .key(function(d) {
                return d["Opportunity Space"];
              })
              .sortKeys(focusAreaSort)
              .entries(
                data.filter(function(d) {
                  if (industryFilter !== "All Startups") {
                    return d.Industry === industryFilter;
                  } else {
                    return d;
                  }
                })
              );

            nodes.attr("opacity", function(d) {
              if (d["Opportunity Space"] === segment_data.data.value.key) {
                return 1;
              } else {
                return 0.3;
              }
            });

            nodes_acquired.attr("opacity", function(d) {
              if (d["Opportunity Space"] === segment_data.data.value.key) {
                return 1;
              } else {
                return 0.3;
              }
            });
          }

          function labelMouseOut() {
            d3.select("#label-mouse-over-text").remove();
            d3.select("#hover-svg-background").remove();
            segmentsLabelBand.attr("opacity", function(d) {
              return d.opacity;
            });
            nodes.attr("opacity", function(d) {
              return d.opacity;
            });
            nodes_acquired.attr("opacity", function(d) {
              return d.opacity;
            });
          }

          function keyMouseOver(data, type) {
            if (type === "acquired") {
              nodes_acquired.attr("opacity", 1);
              nodes.attr("opacity", 0.3);
              nodes_activity.attr("opacity", 0.3);
            }
            /* if (type === "size") {
                nodes.attr("opacity", function(d) {
                  if (nodeSizeScaleFunction(d["Total funding (US$)"]) === data) {
                    return 1;
                  } else {
                    return 0.3;
                  }
                });
                nodes_acquired.attr("opacity", 0.3);
              } */
            if (type === "color") {
              nodes.attr("opacity", function(d) {
                if (fundingCategoryScale(d["Funding \nRound"]) === data) {
                  return 1;
                } else {
                  return 0.3;
                }
              });
              nodes_acquired.attr("opacity", 0.3);
              nodes_activity.attr("opacity", 0.3);
            }

            if (type === "activity") {
              nodes.attr("opacity", function(d) {
                if (d["Activity/Acquisition Time"] != "" && d.hide === false) {
                  return 1;
                } else {
                  return 0.3;
                }
              });

              nodes_activity.attr("opacity", function(d) {
                if (d["Activity/Acquisition Time"] != "") {
                  return 1;
                } else {
                  return 0.3;
                }
              });

              nodes_acquired.attr("opacity", function(d) {
                if (d["Activity/Acquisition Time"] != "" && d.hide === false) {
                  return 1;
                } else {
                  return 0.3;
                }
              });
            }
          }

          function keyMouseOut() {
            nodes.attr("opacity", function(d) {
              return d.opacity;
            });
            nodes_acquired.attr("opacity", function(d) {
              return d.opacity;
            });
          }

          function nodeMouseOver(data) {
            if (radial === "maturity") {
              var nodeX = data.x;
              var nodeY = data.y;
            } else {
              var nodeX = data.yearX;
              var nodeY = data.yearY;
            }

            var dummyHoverText = chartSVG
              .append("text")
              .attr("id", "node-mouse-over-dummy-text")
              .attr("class", "node-mouse-over-text")
              .attr("x", function() {
                return nodeX;
              })
              .attr("y", function() {
                return nodeY;
              })
              .attr("dy", function() {
                return "-0.75em";
              })
              .attr("fill-opacity", 0)
              .html(function() {
                console.log(data);
                console.log(dateForMode(data));
                var x = d3.select(this).attr("x");
                return hover_info(
                  data["Business Description"],
                  data["Startup"],
                  dateForMode(data),
                  data["Total \nfunding (US$)"],
                  x
                );
              });

            var toolBox = chartSVG
              .append("rect")
              .attr("id", "node-mouse-over-box")
              .attr("x", function() {
                var x =
                  nodeX -
                  dummyHoverText.node().getBoundingClientRect().width / 2 -
                  8;
                if (x < -400) {
                  return -400;
                } else {
                  return x;
                }
              })
              .attr("y", function() {
                return (
                  nodeY -
                  dummyHoverText.node().getBoundingClientRect().height -
                  26
                );
              })
              .attr("width", function() {
                return dummyHoverText.node().getBoundingClientRect().width + 16;
              })
              .attr(
                "height",
                dummyHoverText.node().getBoundingClientRect().height + 22
              )
              .style("fill", "white")
              .attr("fill-opacity", 0.9);

            var hoverText = chartSVG
              .append("text")
              .attr("id", "node-mouse-over-actual-text")
              .attr("class", "node-mouse-over-text")
              .attr("x", function() {
                var x =
                  nodeX -
                  dummyHoverText.node().getBoundingClientRect().width / 2;
                if (x < -400) {
                  return -392;
                } else {
                  return x;
                }
              })

              .attr("y", function() {
                return (
                  nodeY -
                  dummyHoverText.node().getBoundingClientRect().height -
                  10
                );
              })
              .attr("dy", function() {
                return "-0.75em";
              })
              .attr("fill-opacity", 1)
              .html(function() {
                var x = d3.select(this).attr("x");
                return hover_info(
                  data["Business Description"],
                  data["Startup"],
                  dateForMode(data),
                  data["Total \nfunding (US$)"],
                  x
                );
              });

            nodes.attr("opacity", function(d) {
              if (d["Funding \nRound"] === data["Funding \nRound"]) {
                return 1;
              } else {
                return 0.3;
              }
            });
            if (data["Funding \nRound"] === "Acquired") {
              nodes_acquired.attr("opacity", 1);
            } else {
              nodes_acquired.attr("opacity", 0.3);
            }
          }

          function nodeMouseOut() {
            d3.select("#node-mouse-over-dummy-text").remove();
            d3.select("#node-mouse-over-box").remove();
            d3.select("#node-mouse-over-actual-text").remove();

            nodes.attr("opacity", function(d) {
              return d.opacity;
            });
            nodes_acquired.attr("opacity", function(d) {
              return d.opacity;
            });
          }
          function save_split() {
            for (let i = 0; i < chartPieData.length; i++) {
              setTimeout(function() {
                var selection =
                  "#background-segment-" +
                  chartPieData[i].data.value.key
                    .replace(/ /g, "-")
                    .replace(/&/g, "and");
                var tmp_width =
                  d3
                    .select(selection)
                    .node()
                    .getBoundingClientRect().width + 100;
                var tmp_height =
                  d3
                    .select(selection)
                    .node()
                    .getBoundingClientRect().height + 100;

                var tmp_svg = d3
                  .select("#tmp-container")
                  .append("svg")
                  .attr("width", tmp_width)
                  .attr("height", tmp_height);

                if (i === 0) {
                  var hor = tmp_width - 200;
                  var ver = tmp_height - 0;
                }
                if (i === 1) {
                  var hor = tmp_width - 300;
                  var ver = tmp_height - 25;
                }
                if (i === 2) {
                  var hor = tmp_width - 350;
                  var ver = tmp_height - 50;
                }
                if (i === 3) {
                  var hor = tmp_width - 350;
                  var ver = tmp_height - 200;
                }
                if (i === 4) {
                  var hor = tmp_width - 300;
                  var ver = tmp_height - 325;
                }
                if (i === 5) {
                  var hor = tmp_width - 200;
                  var ver = tmp_height - 375;
                }
                if (i === 6) {
                  var hor = tmp_width - 75;
                  var ver = tmp_height - 375;
                }
                if (i === 7) {
                  var hor = tmp_width - 25;
                  var ver = tmp_height - 325;
                }
                if (i === 8) {
                  var hor = tmp_width - 0;
                  var ver = tmp_height - 200;
                }
                if (i === 9) {
                  var hor = tmp_width - 25;
                  var ver = tmp_height - 75;
                }
                if (i === 10) {
                  var hor = tmp_width - 25;
                  var ver = tmp_height - 25;
                }
                if (i === 11) {
                  var hor = tmp_width - 25;
                  var ver = tmp_height - 25;
                }

                var tmp_chartSVG = tmp_svg
                  .append("g")
                  .attr("transform", "translate(" + hor + "," + ver + ")");

                if (radial === "maturity") {
                  var tmp_existingSegments = tmp_chartSVG
                    .selectAll("existing-segments")
                    .data([chartPieData[i]])
                    .enter()
                    .append("path")
                    .style("fill-opacity", 1)
                    .attr("class", function(d) {
                      //console.log(d)
                      return (
                        "existing-segments segment-" +
                        d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
                      );
                    })
                    .attr("id", function(d) {
                      return (
                        "tmp-existing-segment-" +
                        d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
                      );
                    })
                    .style("stroke", "white")
                    .style("stroke-width", "2px")
                    .attr("fill", "#DFDFDF") //F4F4F4
                    .attr("d", existingArc);

                  var tmp_emergingSegments = tmp_chartSVG
                    .selectAll("emerging-segments")
                    .data([chartPieData[i]])
                    .enter()
                    .append("path")
                    .style("fill-opacity", 1)
                    .attr("class", function(d) {
                      return (
                        "emerging-segments segment-" +
                        d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
                      );
                    })
                    .attr("id", function(d) {
                      return (
                        "tmp-emerging-segment-" +
                        d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
                      );
                    })
                    .style("stroke", "white")
                    .style("stroke-width", "2px")
                    .attr("fill", "#E9E9E9")
                    .attr("d", emergingArc);

                  var tmp_distantSegments = tmp_chartSVG
                    .selectAll("distant-segments")
                    .data([chartPieData[i]])
                    .enter()
                    .append("path")
                    .style("fill-opacity", 1)
                    .attr("class", function(d) {
                      return (
                        "distant-segments segment-" +
                        d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
                      );
                    })
                    .attr("id", function(d) {
                      return (
                        "tmp-distant-segment-" +
                        d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
                      );
                    })
                    .style("stroke", "white")
                    .style("stroke-width", "2px")
                    .attr("fill", "#F4F4F4") //DFDFDF
                    .attr("d", distantArc);
                } else {
                  count_by_year.forEach(function(v) {
                    var tmpArc = d3
                      .arc()
                      .innerRadius(v.inner)
                      .outerRadius(v.outer);

                    var tmpSegment = tmp_chartSVG
                      .selectAll("year-segment")
                      .data([chartPieData[i]])
                      .enter()
                      .append("path")
                      .attr("class", "segment")
                      .attr("d", tmpArc)
                      .attr("fill", "#f4f4f4");
                  });
                }

                var tmpSegmentsLabelBand = tmp_chartSVG
                  .selectAll("path.segment-band")
                  .data([chartPieData[i]])
                  .enter()
                  .append("path")
                  .classed("segment-band", true)
                  .attr("d", segmentLabelBandArc)
                  .attr("fill", function(d) {
                    return focusAreaeBandColorScale(d.data.value.key);
                  });

                var tmpLabels = tmp_chartSVG
                  .append("g")
                  .classed("labels", true);
                var tmpLabelsOther = tmp_chartSVG
                  .append("g")
                  .classed("labels", true);

                tmpLabels
                  .append("def")
                  .append("path")
                  .attr("id", "label-path")
                  .attr(
                    "d",
                    "m0 " +
                      -labelRadius +
                      " a" +
                      labelRadius +
                      " " +
                      labelRadius +
                      " 0 1,1 -0.01 0"
                  );

                tmpLabelsOther
                  .append("def")
                  .append("path")
                  .attr("id", "label-other-path")
                  .attr(
                    "d",
                    "m0 " +
                      -labelOtherRadius +
                      " a" +
                      labelOtherRadius +
                      " " +
                      labelOtherRadius +
                      " 0 1,1 -0.01 0"
                  );

                tmpLabels
                  .selectAll("text")
                  .data([chartPieData[i]])
                  .enter()
                  .append("text")
                  .attr("class", "label-text")
                  .append("textPath")
                  .attr("xlink:href", "#label-path")
                  .attr("startOffset", function(d, i) {
                    var percentage =
                      ((d.endAngle - d.startAngle) / 2 + d.startAngle) /
                      0.0628319;
                    return percentage + "%";
                  })
                  .text(function(d) {
                    return label_wrap(d.data.value.key.toUpperCase())[0];
                  });

                tmpLabelsOther
                  .selectAll("text")
                  .data([chartPieData[i]])
                  .enter()
                  .append("text")
                  .attr("class", "label-text")
                  .append("textPath")
                  .attr("xlink:href", "#label-other-path")
                  .attr("startOffset", function(d, i) {
                    var percentage =
                      ((d.endAngle - d.startAngle) / 2 + d.startAngle) /
                      0.0628319;
                    return percentage + "%";
                  })
                  .text(function(d) {
                    var result = label_wrap(d.data.value.key.toUpperCase());
                    if (result.length > 2) {
                      return result[1] + " " + result[2];
                    } else {
                      return result[1];
                    }
                  });

                var tmp_nodes = tmp_chartSVG
                  .selectAll("nodes")
                  .data(data)
                  .enter()
                  .append("circle")
                  .attr("class", "nodes")
                  .attr("r", function(d) {
                    if (d["Funding \nRound"] !== "Acquired") {
                      return 3.4;
                    }
                  })
                  .attr("opacity", function(d) {
                    return d.opacity;
                  })
                  .attr("fill", function(d) {
                    return nodeColorScale(
                      fundingCategoryScale(d["Funding \nRound"])
                    );
                  })
                  .attr("cx", function(d) {
                    if (radial === "maturity") {
                      return d.x;
                    } else {
                      return d.yearX;
                    }
                  })
                  .attr("cy", function(d) {
                    if (radial === "maturity") {
                      return d.y;
                    } else {
                      return d.yearY;
                    }
                  })
                  .attr("opacity", function(d) {
                    if (
                      d["Opportunity Space"] === chartPieData[i].data.value.key
                    ) {
                      return d.opacity;
                    } else {
                      return 0;
                    }
                  });

                var tmp_acquired = tmp_chartSVG
                  .selectAll("nodes-acquired")
                  .data(data)
                  .enter()
                  .append("rect")
                  .attr("class", "nodes nodes-acquired")
                  .attr("opacity", function(d) {
                    return d.opacity;
                  })
                  .attr("opacity", function(d) {
                    return d.opacity;
                  })
                  .attr("width", function(d) {
                    if (d["Funding \nRound"] === "Acquired") {
                      return 8.8;
                    } else {
                      return 0;
                    }
                  })
                  .attr("height", function(d) {
                    if (d["Funding \nRound"] === "Acquired") {
                      return 8.8;
                    } else {
                      return 0;
                    }
                  })
                  .attr("x", 0)
                  .attr("y", 0)
                  .attr("fill", "#FFFD82")
                  .attr("transform", function(d) {
                    if (radial === "maturity") {
                      var x = d.x;
                      var y = d.y;
                    } else {
                      var x = d.yearX;
                      var y = d.yearY;
                    }
                    return "translate(" + x + "," + y + ")    rotate(45)";
                  })
                  .attr("opacity", function(d) {
                    if (
                      d["Opportunity Space"] === chartPieData[i].data.value.key
                    ) {
                      return d.opacity;
                    } else {
                      return 0;
                    }
                  });

                var name = chartPieData[i].data.value.key;

                var svgString = getSVGString(tmp_svg.node());

                svgString2Image(
                  svgString,
                  tmp_width * 2,
                  tmp_height * 2,
                  "png",
                  name,
                  save
                );

                function save(dataBlob, filesize, name) {
                  saveAs(dataBlob, "radar " + name + ".png");
                }

                tmp_svg.remove();
              }, 200 * i);
            }
          }

          function toggle_map(type) {
              if (type === "on") {
                  d3.select(".map-container").style("display", "")
                  d3.select(".map-tooltip").style("display", "none");
                  d3.select("#chart-container").style("display", "none")
                  d3.select("#key-container").style("display", "none")
                  d3.select("#control-container").style("display", "none")
                  d3.select("#hover-info-container").style("display", "none")
                  d3.select("#save-button-container").style("display", "none")
              } else {
                d3.select(".map-container").style("display", "none")
                d3.select(".map-tooltip").style("display", "none");
                  d3.select("#chart-container").style("display", "")
                  d3.select("#key-container").style("display", "")
                  d3.select("#control-container").style("display", "")
                  d3.select("#hover-info-container").style("display", "")
                  d3.select("#save-button-container").style("display", "")
              }
          }

          d3.select("#map-button").on("click", function() {
            toggle_map("on")
          })

          // Set-up the export button
          d3.select("#save-button").on("click", function() {
            save_split();

            var svgString = getSVGString(svg.node());
            var name = "";

            svgString2Image(
              svgString,
              width * 2,
              height * 2,
              "png",
              name,
              save
            );

            function save(dataBlob, filesize, name) {
              saveAs(dataBlob, "radar.png");
            }
            // passes Blob and filesize String to the callback
          });

          // Below are the functions that handle actual exporting:
          // getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
          function getSVGString(svgNode) {
            svgNode.setAttribute("xlink", "http://www.w3.org/1999/xlink");
            var cssStyleText = getCSSStyles(svgNode);
            appendCSS(cssStyleText, svgNode);

            var serializer = new XMLSerializer();
            var svgString = serializer.serializeToString(svgNode);
            svgString = svgString.replace(/(\w+)?:?xlink=/g, "xmlns:xlink=");
            svgString = svgString.replace(/NS\d+:href/g, "xlink:href");
            svgString = svgString.replace(/"Graphik Regular";/g, "arial;");
            svgString = svgString.replace(/"Graphik Bold";/g, "arial;");

            return svgString;

            function getCSSStyles(parentElement) {
              var selectorTextArr = [];

              // Add Parent element Id and Classes to the list
              selectorTextArr.push("#" + parentElement.id);
              for (var c = 0; c < parentElement.classList.length; c++)
                if (
                  !contains("." + parentElement.classList[c], selectorTextArr)
                )
                  selectorTextArr.push("." + parentElement.classList[c]);

              // Add Children element Ids and Classes to the list
              var nodes = parentElement.getElementsByTagName("*");
              for (var i = 0; i < nodes.length; i++) {
                var id = nodes[i].id;

                if (!contains("#" + id, selectorTextArr))
                  selectorTextArr.push("#" + id);

                var classes = nodes[i].classList;
                for (var c = 0; c < classes.length; c++)
                  if (!contains("." + classes[c], selectorTextArr))
                    selectorTextArr.push("." + classes[c]);
              }
              // Extract CSS Rules
              var extractedCSSText = "";
              for (var i = 0; i < document.styleSheets.length; i++) {
                var s = document.styleSheets[i];

                try {
                  if (!s.cssRules) continue;
                } catch (e) {
                  if (e.name !== "SecurityError") throw e;
                  continue;
                }

                var cssRules = s.cssRules;

                //manually add css rules:
                selectorTextArr.push("textPath");

                for (var r = 0; r < cssRules.length; r++) {
                  if (contains(cssRules[r].selectorText, selectorTextArr))
                    extractedCSSText += cssRules[r].cssText;
                }
              }

              return extractedCSSText;

              function contains(str, arr) {
                return arr.indexOf(str) === -1 ? false : true;
              }
            }

            function appendCSS(cssText, element) {
              var styleElement = document.createElement("style");
              styleElement.setAttribute("type", "text/css");
              styleElement.innerHTML = cssText;
              var refNode = element.hasChildNodes()
                ? element.children[0]
                : null;
              element.insertBefore(styleElement, refNode);
            }
          }
        });

        })
      });

      function round_to_precision(x, precision) {
        var y = +x + (precision === undefined ? 0.5 : precision / 2);
        return y - (y % (precision === undefined ? 1 : +precision));
      }

      const capitalize_word = s => {
        if (typeof s !== "string") return "";
        return s.charAt(0).toUpperCase() + s.slice(1);
      };

      function capitalize_sentence(string) {
        var res = string.split(" ");
        result_list = [];
        for (i = 0; i < res.length; i++) {
          result_list.push(capitalize_word(res[i]));
        }
        return result_list.join(" ");
      }

      function formatFunding(total_funding) {
        fundingFormatted = total_funding;
        if (total_funding <= 900000 && total_funding > 1000) {
          fundingFormatted = Math.round(total_funding / 10) / 100 + "K";
        }
        if (total_funding > 900000) {
          fundingFormatted = Math.round(total_funding / 10000) / 100 + "M";
        }
        return fundingFormatted;
      }

      function hover_info(
        text_data,
        text_title,
        funding_year,
        total_funding,
        x,
        limit = 35
      ) {
        fundingFormatted = formatFunding(total_funding);

        words = text_data.split(/\s+/);
        //console.log(words_alt);
        lines = [];
        current_seq_len = 0;
        current_seq = [];
        result =
          "<tspan x=" +
          x +
          " dy='0em' class='wrap-header'>" +
          text_title +
          "</tspan>" +
          "<tspan x=" +
          x +
          " dy='1.1em' class='wrap-year'>Founded: " +
          funding_year +
          "</tspan>" +
          "<tspan x=" +
          x +
          " dy='1.1em' class='wrap-year'>Total Funding: $" +
          fundingFormatted +
          "</tspan>";
        for (i = 0; i < words.length; i++) {
          current_seq_len += words[i].length;
          current_seq.push(words[i].replace(//g, "'"));
          if (current_seq_len > limit) {
            lines.push(current_seq);
            current_seq_len = 0;
            current_seq = [];
          }
        }
        lines.push(current_seq);
        for (i = 0; i < lines.length; i++) {
          tmp = "";
          for (j = 0; j < lines[i].length; j++) {
            if (j !== lines[i].length - 1) {
              tmp += lines[i][j] + " ";
            } else {
              tmp += lines[i][j];
            }
          }
          result += "<tspan x=" + x + " dy='1.1em'>" + tmp + "</tspan>";
        }
        return result;
      }

      function label_wrap(text_data, limit = 7) {
        words = text_data.split(/\s+/);
        //console.log(words_alt);
        lines = [];
        current_seq_len = 0;
        current_seq = [];
        result = [];
        for (i = 0; i < words.length; i++) {
          current_seq_len += words[i].length;
          current_seq.push(words[i].replace(//g, "'"));
          if (current_seq_len > limit) {
            lines.push(current_seq);
            current_seq_len = 0;
            current_seq = [];
          }
        }
        lines.push(current_seq);
        for (i = 0; i < lines.length; i++) {
          tmp = "";
          for (j = 0; j < lines[i].length; j++) {
            if (j !== lines[i].length - 1) {
              tmp += lines[i][j] + " ";
            } else {
              tmp += lines[i][j];
            }
          }
          var dx = -tmp.length + "em";
          result.push(tmp);
        }
        return result;
      }

      function svgString2Image(
        svgString,
        width,
        height,
        format,
        name,
        callback
      ) {
        var format = format ? format : "png";

        var imgsrc =
          "data:image/svg+xml;base64," +
          btoa(unescape(encodeURIComponent(svgString)));

        var canvas = document.createElement("canvas");
        var context = canvas.getContext("2d");

        canvas.width = width;
        canvas.height = height;

        var image = new Image();
        image.onload = function() {
          context.clearRect(0, 0, width, height);
          context.drawImage(image, 0, 0, width, height);

          canvas.toBlob(function(blob) {
            var filesize = Math.round(blob.length / 1024) + " KB";
            if (callback) callback(blob, filesize, name);
          });
        };

        image.src = imgsrc;
      }

      function assignRandom(
        tmp_startAngleMin,
        tmp_endAngleMax,
        tmp_innerRadiusMin,
        tmp_outerRadiusMax,
        nodeList
      ) {
        tmp_startAngle =
          Math.random() * (tmp_endAngleMax - tmp_startAngleMin) +
          tmp_startAngleMin;
        tmp_endAngle =
          Math.random() * (tmp_endAngleMax - tmp_startAngle) + tmp_startAngle;
        tmp_innerRadius =
          Math.random() * (tmp_outerRadiusMax - tmp_innerRadiusMin) +
          tmp_innerRadiusMin;
        tmp_outerRadius =
          Math.random() * (tmp_outerRadiusMax - tmp_innerRadius) +
          tmp_innerRadius;
        tmp_gen = d3
          .arc()
          .innerRadius(tmp_innerRadius)
          .outerRadius(tmp_outerRadius)
          .startAngle(tmp_startAngle)
          .endAngle(tmp_endAngle);

        tmp_x = tmp_gen.centroid()[0];
        tmp_y = tmp_gen.centroid()[1];

        if (nodeList.length !== 0) {
          var distanceCheck = 0;
          for (l = 0; l < nodeList.length; l++) {
            distance = Math.sqrt(
              Math.pow(nodeList[l][0] - tmp_x, 2) +
                Math.pow(nodeList[l][1] - tmp_y, 2)
            );
            if (distance <= 2) {
              distanceCheck = 1;
            }
          }
          if (distanceCheck === 1) {
            return assignRandom(
              tmp_startAngleMin,
              tmp_endAngleMax,
              tmp_innerRadiusMin,
              tmp_outerRadiusMax,
              nodeList
            );
          } else {
            nodeList.push([tmp_x, tmp_y]);
            return [tmp_x, tmp_y];
          }
        } else {
          nodeList.push([tmp_x, tmp_y]);
          return [tmp_x, tmp_y];
        }
      }
    </script>
  </body>
</html>
